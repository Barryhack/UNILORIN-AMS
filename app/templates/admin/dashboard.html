{% extends 'base.html' %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Welcome Section -->
    <div class="mb-8">
        <div class="bg-gradient-to-r from-[#002147] to-[#003366] rounded-2xl shadow-xl p-8">
            <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-white mb-2">Welcome back, {{ current_user.name }}!</h1>
                    <p class="text-[#FFD700] text-lg">{{ datetime.now().strftime('%A, %B %d, %Y') }}</p>
                </div>
                <div class="text-white text-right bg-white/10 p-4 rounded-xl backdrop-blur-sm">
                    <p class="text-sm text-[#FFD700]">Last Login</p>
                    <p class="font-semibold">{{ current_user.last_login.strftime('%Y-%m-%d %H:%M:%S') if current_user.last_login else 'First Login' }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Hardware Status Section -->
    <div class="mb-8">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Hardware Control Center</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Status Card -->
                <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">System Status</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600 dark:text-gray-300">Connection:</span>
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full mr-2 {{ 'bg-green-500' if hardware_status.connected else 'bg-red-500' }}"></div>
                                <span class="text-sm font-medium {{ 'text-green-600 dark:text-green-400' if hardware_status.connected else 'text-red-600 dark:text-red-400' }}">
                                    {{ 'Connected' if hardware_status.connected else 'Disconnected' }}
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600 dark:text-gray-300">Mode:</span>
                            <span class="text-sm font-medium text-gray-900 dark:text-white">{{ hardware_status.mode|title }}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600 dark:text-gray-300">Fingerprint Reader:</span>
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full mr-2 {{ 'bg-green-500' if hardware_status.fingerprint_ready else 'bg-red-500' }}"></div>
                                <span class="text-sm font-medium {{ 'text-green-600 dark:text-green-400' if hardware_status.fingerprint_ready else 'text-red-600 dark:text-red-400' }}">
                                    {{ 'Ready' if hardware_status.fingerprint_ready else 'Not Ready' }}
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600 dark:text-gray-300">RFID Reader:</span>
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full mr-2 {{ 'bg-green-500' if hardware_status.rfid_ready else 'bg-red-500' }}"></div>
                                <span class="text-sm font-medium {{ 'text-green-600 dark:text-green-400' if hardware_status.rfid_ready else 'text-red-600 dark:text-red-400' }}">
                                    {{ 'Ready' if hardware_status.rfid_ready else 'Not Ready' }}
                                </span>
                            </div>
                        </div>
                        {% if hardware_status.last_sync %}
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600 dark:text-gray-300">Last Sync:</span>
                            <span class="text-sm font-medium text-gray-900 dark:text-white">{{ hardware_status.last_sync.strftime('%H:%M:%S') }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Control Card -->
                <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Controls</h3>
                    <div class="space-y-4">
                        <button onclick="connectHardware()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                            {{ 'Disconnect' if hardware_status.connected else 'Connect' }}
                        </button>
                        <button onclick="resetHardware()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200" {{ 'disabled' if not hardware_status.connected }}>
                            Reset Hardware
                        </button>
                        <button onclick="testHardware()" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200" {{ 'disabled' if not hardware_status.connected }}>
                            Test Device
                        </button>
                    </div>
                </div>

                <!-- Log Card -->
                <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Hardware Logs</h3>
                    <div id="hardware-logs" class="space-y-2 h-[200px] overflow-y-auto">
                        {% if hardware_status.last_error %}
                        <div class="flex items-start space-x-2 text-red-600 dark:text-red-400">
                            <i class="fas fa-exclamation-circle mt-1"></i>
                            <span class="text-sm">{{ hardware_status.last_error }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Users Card -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Total Users</p>
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white">{{ stats.total_users }}</h3>
                </div>
                <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-lg">
                    <i class="fas fa-users text-blue-600 dark:text-blue-400 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Students Card -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-green-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Students</p>
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white">{{ stats.total_students }}</h3>
                </div>
                <div class="bg-green-100 dark:bg-green-900 p-3 rounded-lg">
                    <i class="fas fa-user-graduate text-green-600 dark:text-green-400 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Lecturers Card -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Lecturers</p>
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white">{{ stats.total_lecturers }}</h3>
                </div>
                <div class="bg-purple-100 dark:bg-purple-900 p-3 rounded-lg">
                    <i class="fas fa-chalkboard-teacher text-purple-600 dark:text-purple-400 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Today's Attendance Card -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-yellow-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Today's Attendance</p>
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white">{{ stats.today_attendance }}</h3>
                </div>
                <div class="bg-yellow-100 dark:bg-yellow-900 p-3 rounded-lg">
                    <i class="fas fa-clipboard-check text-yellow-600 dark:text-yellow-400 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity and Logs -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Recent Activity -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Recent Activity</h3>
            <div class="space-y-4">
                {% for activity in recent_activities %}
                <div class="flex items-start space-x-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center">
                            <i class="fas fa-history text-blue-600 dark:text-blue-400"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 dark:text-white">
                            {{ activity.action }}
                        </p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            {{ activity.details }}
                        </p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
                            {{ activity.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                        </p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Recent Logins -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Recent Logins</h3>
            <div class="space-y-4">
                {% for log in recent_logins %}
                <div class="flex items-start space-x-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center">
                            <i class="fas fa-sign-in-alt text-green-600 dark:text-green-400"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 dark:text-white">
                            {{ log.user.name if log.user else 'Unknown User' }}
                        </p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            {{ log.action }} - {{ log.status }}
                        </p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
                            {{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                        </p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Hardware Control Functions
let hardwareConnected = {{ 'true' if hardware_status.connected else 'false' }};

function updateHardwareStatus() {
    fetch('/admin/hardware/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();  // Refresh to update all status indicators
            }
        })
        .catch(error => addHardwareLog('Error updating status: ' + error));
}

function connectHardware() {
    const endpoint = hardwareConnected ? '/admin/hardware/disconnect' : '/admin/hardware/connect';
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            hardwareConnected = !hardwareConnected;
            updateHardwareStatus();
        } else {
            addHardwareLog('Error: ' + data.error);
        }
    })
    .catch(error => addHardwareLog('Error: ' + error));
}

function resetHardware() {
    fetch('/admin/hardware/reset', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateHardwareStatus();
        } else {
            addHardwareLog('Error: ' + data.error);
        }
    })
    .catch(error => addHardwareLog('Error: ' + error));
}

function testHardware() {
    fetch('/admin/hardware/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addHardwareLog('Test completed successfully');
            if (data.test_result) {
                addHardwareLog('Test result: ' + JSON.stringify(data.test_result));
            }
            updateHardwareStatus();
        } else {
            addHardwareLog('Error: ' + data.error);
        }
    })
    .catch(error => addHardwareLog('Error: ' + error));
}

function addHardwareLog(message) {
    const logsContainer = document.getElementById('hardware-logs');
    const logEntry = document.createElement('div');
    logEntry.className = 'flex items-start space-x-2 text-gray-600 dark:text-gray-400';
    
    const timestamp = new Date().toLocaleTimeString();
    logEntry.innerHTML = `
        <span class="text-xs">[${timestamp}]</span>
        <span class="text-sm">${message}</span>
    `;
    
    logsContainer.insertBefore(logEntry, logsContainer.firstChild);
}

// Update status periodically
setInterval(updateHardwareStatus, 30000);  // Every 30 seconds
</script>
{% endblock %}
