{% extends 'base.html' %}

{% block title %}Admin Dashboard{% endblock %}

{% block styles %}
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Welcome Banner -->
    <div class="welcome-banner">
        <div class="flex flex-col lg:flex-row justify-between items-center">
            <div>
                <h1>Welcome back, {{ current_user.name }}!</h1>
                <p class="text-gold">{{ datetime.now().strftime('%A, %B %d, %Y') }}</p>
            </div>
            <div class="text-white text-right bg-white/10 p-4 rounded-xl backdrop-blur-sm">
                <p class="text-sm text-gold">Last Login</p>
                <p class="font-semibold">{{ current_user.last_login.strftime('%Y-%m-%d %H:%M:%S') if current_user.last_login else 'First Login' }}</p>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions-grid">
        <a href="{{ url_for('admin.departments') }}" class="quick-action-card">
            <div class="icon-wrapper bg-green-100">
                <i class="fas fa-building text-green-600"></i>
            </div>
            <span>Manage Departments</span>
        </a>
        <a href="{{ url_for('admin.courses') }}" class="quick-action-card">
            <div class="icon-wrapper bg-purple-100">
                <i class="fas fa-book text-purple-600"></i>
            </div>
            <span>Manage Courses</span>
        </a>
        <a href="{{ url_for('admin.reports') }}" class="quick-action-card">
            <div class="icon-wrapper bg-blue-100">
                <i class="fas fa-chart-bar text-blue-600"></i>
            </div>
            <span>View Reports</span>
        </a>
    </div>

    <!-- Statistics Grid -->
    <div class="stats-grid">
        <!-- Total Users -->
        <div class="stat-card">
            <div class="stat-icon bg-blue-100">
                <i class="fas fa-users text-blue-600"></i>
            </div>
            <div class="stat-content">
                <h3>Total Users</h3>
                <p class="stat-value">{{ stats.total_users }}</p>
            </div>
        </div>

        <!-- Students -->
        <div class="stat-card">
            <div class="stat-icon bg-green-100">
                <i class="fas fa-user-graduate text-green-600"></i>
            </div>
            <div class="stat-content">
                <h3>Students</h3>
                <p class="stat-value">{{ stats.total_students }}</p>
            </div>
        </div>

        <!-- Lecturers -->
        <div class="stat-card">
            <div class="stat-icon bg-purple-100">
                <i class="fas fa-chalkboard-teacher text-purple-600"></i>
            </div>
            <div class="stat-content">
                <h3>Lecturers</h3>
                <p class="stat-value">{{ stats.total_lecturers }}</p>
            </div>
        </div>

        <!-- Today's Attendance -->
        <div class="stat-card">
            <div class="stat-icon bg-yellow-100">
                <i class="fas fa-clipboard-check text-yellow-600"></i>
            </div>
            <div class="stat-content">
                <h3>Today's Attendance</h3>
                <p class="stat-value">{{ stats.today_attendance }}</p>
            </div>
        </div>
    </div>

    <!-- Hardware Status -->
    <div class="hardware-status-section">
        <h2>Hardware Status</h2>
        <div class="hardware-grid">
            <!-- Fingerprint Scanner -->
            <div class="hardware-card">
                <div class="hardware-header">
                    <h3>Fingerprint Scanner</h3>
                    <span class="status-badge {{ 'connected' if hardware_status.fingerprint_ready else 'disconnected' }}">
                        {{ 'Connected' if hardware_status.fingerprint_ready else 'Disconnected' }}
                    </span>
                </div>
                <div class="hardware-actions">
                    <button onclick="connectHardware()" class="btn-primary">
                        {{ 'Disconnect' if hardware_status.connected else 'Connect' }}
                    </button>
                    <button onclick="testHardware()" class="btn-secondary" {{ 'disabled' if not hardware_status.connected }}>
                        Test
                    </button>
                </div>
            </div>

            <!-- RFID Reader -->
            <div class="hardware-card">
                <div class="hardware-header">
                    <h3>RFID Reader</h3>
                    <span class="status-badge {{ 'connected' if hardware_status.rfid_ready else 'disconnected' }}">
                        {{ 'Connected' if hardware_status.rfid_ready else 'Disconnected' }}
                    </span>
                </div>
                <div class="hardware-actions">
                    <button onclick="connectHardware()" class="btn-primary">
                        {{ 'Disconnect' if hardware_status.connected else 'Connect' }}
                    </button>
                    <button onclick="testHardware()" class="btn-secondary" {{ 'disabled' if not hardware_status.connected }}>
                        Test
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hardware Logs -->
    <div class="hardware-logs-section">
        <h2>Hardware Logs</h2>
        <div id="hardware-logs" class="logs-container">
            {% if hardware_status.last_error %}
            <div class="log-entry error">
                <i class="fas fa-exclamation-circle"></i>
                <span>{{ hardware_status.last_error }}</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let hardwareConnected = {{ 'true' if hardware_status.connected else 'false' }};

function updateHardwareStatus() {
    fetch('/admin/hardware/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => addHardwareLog('Error updating status: ' + error));
}

function connectHardware() {
    const endpoint = hardwareConnected ? '/admin/hardware/disconnect' : '/admin/hardware/connect';
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            hardwareConnected = !hardwareConnected;
            updateHardwareStatus();
        } else {
            addHardwareLog('Error: ' + data.error);
        }
    })
    .catch(error => addHardwareLog('Error: ' + error));
}

function resetHardware() {
    fetch('/admin/hardware/reset', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateHardwareStatus();
        } else {
            addHardwareLog('Error: ' + data.error);
        }
    })
    .catch(error => addHardwareLog('Error: ' + error));
}

function testHardware() {
    fetch('/admin/hardware/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addHardwareLog('Test completed successfully');
            if (data.test_result) {
                addHardwareLog('Test result: ' + JSON.stringify(data.test_result));
            }
            updateHardwareStatus();
        } else {
            addHardwareLog('Error: ' + data.error);
        }
    })
    .catch(error => addHardwareLog('Error: ' + error));
}

function addHardwareLog(message) {
    const logsContainer = document.getElementById('hardware-logs');
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    
    const timestamp = new Date().toLocaleTimeString();
    logEntry.innerHTML = `
        <span class="log-timestamp">[${timestamp}]</span>
        <span class="log-message">${message}</span>
    `;
    
    logsContainer.insertBefore(logEntry, logsContainer.firstChild);
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Set up periodic status updates
    setInterval(updateHardwareStatus, 30000);  // Every 30 seconds
});
</script>
{% endblock %}
