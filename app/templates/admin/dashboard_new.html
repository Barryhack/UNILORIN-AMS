{% extends "admin/admin_base.html" %}

{% block title %}Dashboard{% endblock %}

{% block extra_styles %}
<style>
    :root {
        --unilorin-blue: #002147;
        --unilorin-gold: #FFD700;
        --white: #ffffff;
        --gray-50: #F9FAFB;
        --gray-100: #F3F4F6;
        --gray-200: #E5E7EB;
        --gray-300: #D1D5DB;
        --gray-400: #9CA3AF;
        --gray-500: #6B7280;
        --gray-600: #4B5563;
        --gray-700: #374151;
        --gray-800: #1F2937;
        --gray-900: #111827;
    }

    .bg-unilorin-blue { background-color: var(--unilorin-blue); }
    .text-unilorin-blue { color: var(--unilorin-blue); }
    .bg-unilorin-gold { background-color: var(--unilorin-gold); }
    .text-unilorin-gold { color: var(--unilorin-gold); }
    .hover-unilorin-gold:hover { background-color: var(--unilorin-gold); }
    
    .card {
        @apply bg-white rounded-xl shadow-lg border border-gray-100 transition-all duration-300;
    }
    
    .card:hover {
        @apply shadow-xl transform -translate-y-1;
    }
    
    .stat-card {
        @apply flex flex-col p-6 bg-white rounded-xl shadow-lg border border-gray-100;
    }
    
    .stat-card:hover {
        @apply shadow-xl transform -translate-y-1;
    }
    
    .stat-value {
        @apply text-3xl font-bold text-unilorin-blue mt-2;
    }
    
    .stat-label {
        @apply text-sm text-gray-500 font-medium;
    }
    
    .stat-icon {
        @apply w-8 h-8 text-unilorin-blue opacity-20 absolute right-4 top-4;
    }
    
    .activity-item {
        @apply flex items-center p-4 rounded-lg transition-all duration-300;
    }
    
    .activity-item:hover {
        @apply bg-gray-50;
    }
    
    .btn-primary {
        @apply bg-unilorin-blue text-white px-6 py-3 rounded-lg hover:bg-unilorin-gold hover:text-unilorin-blue transition-all duration-300 flex items-center gap-2 font-medium;
    }
    
    .btn-secondary {
        @apply bg-gray-100 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-200 transition-all duration-300 flex items-center gap-2 font-medium;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="stat-card relative">
            <i class="fas fa-users stat-icon"></i>
            <span class="stat-label">Total Users</span>
            <span class="stat-value">{{ stats.total_users }}</span>
        </div>
        <div class="stat-card relative">
            <i class="fas fa-book stat-icon"></i>
            <span class="stat-label">Total Courses</span>
            <span class="stat-value">{{ stats.total_courses }}</span>
        </div>
        <div class="stat-card relative">
            <i class="fas fa-building stat-icon"></i>
            <span class="stat-label">Departments</span>
            <span class="stat-value">{{ stats.total_departments }}</span>
        </div>
        <div class="stat-card relative">
            <i class="fas fa-clock stat-icon"></i>
            <span class="stat-label">Today's Attendance</span>
            <span class="stat-value">{{ stats.today_attendance }}</span>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="flex flex-wrap gap-4 mb-8">
        <button onclick="openHardwareModal()" class="btn-primary">
            <i class="fas fa-microchip"></i>
            <span>Hardware Status</span>
            <span id="hardware-status-badge" class="ml-2 px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-800">
                Unknown
            </span>
        </button>
        <a href="{{ url_for('admin.register_user') }}" class="btn-primary">
            <i class="fas fa-user-plus"></i>
            <span>Register User</span>
        </a>
        <a href="{{ url_for('admin.manage_courses') }}" class="btn-primary">
            <i class="fas fa-book"></i>
            <span>Manage Courses</span>
        </a>
        <a href="{{ url_for('admin.activity_logs') }}" class="btn-primary">
            <i class="fas fa-list"></i>
            <span>Activity Logs</span>
        </a>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="card p-6">
            <h3 class="text-lg font-semibold text-unilorin-blue mb-4 flex items-center gap-2">
                <i class="fas fa-chart-line"></i>
                <span>Attendance Trends</span>
            </h3>
            <div class="h-64">
                <canvas id="attendanceChart"></canvas>
            </div>
        </div>
        <div class="card p-6">
            <h3 class="text-lg font-semibold text-unilorin-blue mb-4 flex items-center gap-2">
                <i class="fas fa-chart-pie"></i>
                <span>Department Distribution</span>
            </h3>
            <div class="h-64">
                <canvas id="departmentChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Activities and Registrations -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="card p-6">
            <h3 class="text-lg font-semibold text-unilorin-blue mb-4 flex items-center gap-2">
                <i class="fas fa-history"></i>
                <span>Recent Activities</span>
            </h3>
            <div class="space-y-4">
                {% for activity in recent_activities %}
                <div class="activity-item">
                    <div class="w-10 h-10 rounded-full bg-unilorin-blue flex items-center justify-center text-white">
                        {{ activity.user.first_name[0].upper() }}
                    </div>
                    <div class="ml-4 flex-1">
                        <p class="text-sm text-gray-600">{{ activity.description }}</p>
                        <p class="text-xs text-gray-400">{{ activity.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
            <a href="{{ url_for('admin.activity_logs') }}" class="mt-4 inline-flex items-center text-unilorin-blue hover:text-unilorin-gold transition-colors duration-300">
                View All Activities
                <i class="fas fa-arrow-right ml-2"></i>
            </a>
        </div>

        <div class="card p-6">
            <h3 class="text-lg font-semibold text-unilorin-blue mb-4 flex items-center gap-2">
                <i class="fas fa-user-plus"></i>
                <span>Recent Registrations</span>
            </h3>
            <div class="space-y-4">
                {% for user in recent_registrations %}
                <div class="activity-item">
                    <div class="w-10 h-10 rounded-full bg-unilorin-gold flex items-center justify-center text-unilorin-blue">
                        {{ user.first_name[0].upper() }}
                    </div>
                    <div class="ml-4 flex-1">
                        <p class="text-sm font-medium text-gray-700">{{ user.first_name }} {{ user.last_name }}</p>
                        <p class="text-xs text-gray-500">{{ user.role.title() }} - {{ user.department.name }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
            <a href="{{ url_for('admin.manage_users') }}" class="mt-4 inline-flex items-center text-unilorin-blue hover:text-unilorin-gold transition-colors duration-300">
                View All Users
                <i class="fas fa-arrow-right ml-2"></i>
            </a>
        </div>
    </div>
</div>

<!-- Hardware Registration Modal -->
<div id="hardware-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 relative">
        <button onclick="closeHardwareModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
        </button>
        
        <h3 class="text-xl font-semibold text-unilorin-blue mb-6 flex items-center gap-2">
            <i class="fas fa-microchip"></i>
            <span>Hardware Status</span>
        </h3>
        
        <div id="hardware-status" class="mb-6">
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-3">
                    <i class="fas fa-circle-notch fa-spin text-unilorin-blue"></i>
                    <span>Checking status...</span>
                </div>
            </div>
        </div>
        
        <div class="flex gap-4">
            <button onclick="startRegistrationProcess()" class="btn-primary flex-1">
                <i class="fas fa-play"></i>
                <span>Start Registration</span>
            </button>
            <button onclick="closeHardwareModal()" class="btn-secondary flex-1">
                <i class="fas fa-times"></i>
                <span>Close</span>
            </button>
        </div>
    </div>
</div>

<script>
    // Charts Configuration
    const attendanceCtx = document.getElementById('attendanceChart').getContext('2d');
    const departmentCtx = document.getElementById('departmentChart').getContext('2d');
    
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    usePointStyle: true,
                    padding: 20
                }
            }
        }
    };
    
    // Attendance Chart
    new Chart(attendanceCtx, {
        type: 'line',
        data: {
            labels: {{ stats.attendance_labels | tojson }},
            datasets: [{
                label: 'Daily Attendance',
                data: {{ stats.attendance_data | tojson }},
                borderColor: '#002147',
                backgroundColor: 'rgba(0, 33, 71, 0.1)',
                borderWidth: 2,
                pointBackgroundColor: '#002147',
                pointRadius: 4,
                pointHoverRadius: 6,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        drawBorder: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
    
    // Department Chart
    new Chart(departmentCtx, {
        type: 'doughnut',
        data: {
            labels: {{ stats.department_labels | tojson }},
            datasets: [{
                data: {{ stats.department_data | tojson }},
                backgroundColor: [
                    '#002147',
                    '#FFD700',
                    '#1E40AF',
                    '#D97706',
                    '#059669',
                    '#DC2626'
                ]
            }]
        },
        options: {
            ...commonOptions,
            cutout: '60%'
        }
    });
    
    // Hardware Status
    function updateHardwareStatus() {
        fetch('/admin/hardware/status')
            .then(response => response.json())
            .then(data => {
                const statusBadge = document.getElementById('hardware-status-badge');
                const statusDiv = document.getElementById('hardware-status');
                
                let statusClass = '';
                let iconClass = '';
                
                switch(data.status) {
                    case 'Connected':
                        statusClass = 'bg-green-100 text-green-800';
                        iconClass = 'text-green-500';
                        break;
                    case 'Not Connected':
                        statusClass = 'bg-yellow-100 text-yellow-800';
                        iconClass = 'text-yellow-500';
                        break;
                    case 'Error':
                        statusClass = 'bg-red-100 text-red-800';
                        iconClass = 'text-red-500';
                        break;
                    default:
                        statusClass = 'bg-gray-100 text-gray-800';
                        iconClass = 'text-gray-500';
                }
                
                statusBadge.className = `ml-2 px-2 py-1 text-xs rounded-full ${statusClass}`;
                statusBadge.textContent = data.status;
                
                statusDiv.innerHTML = `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-plug ${iconClass}"></i>
                            <span>${data.status}</span>
                        </div>
                        <span class="text-sm text-gray-500">${data.port || 'N/A'}</span>
                    </div>
                    ${data.message ? `
                    <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600">${data.message}</p>
                    </div>
                    ` : ''}
                `;
            })
            .catch(error => {
                console.error('Error fetching hardware status:', error);
                const statusBadge = document.getElementById('hardware-status-badge');
                statusBadge.className = 'ml-2 px-2 py-1 text-xs rounded-full bg-red-100 text-red-800';
                statusBadge.textContent = 'Error';
            });
    }
    
    // Update hardware status every 5 seconds
    updateHardwareStatus();
    setInterval(updateHardwareStatus, 5000);
    
    // Modal Functions
    function openHardwareModal() {
        document.getElementById('hardware-modal').classList.remove('hidden');
        document.getElementById('hardware-modal').classList.add('flex');
    }
    
    function closeHardwareModal() {
        document.getElementById('hardware-modal').classList.add('hidden');
        document.getElementById('hardware-modal').classList.remove('flex');
    }
    
    function resetRegistrationProcess() {
        document.getElementById('registration-steps').innerHTML = `
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-3">
                    <i class="fas fa-fingerprint text-unilorin-blue"></i>
                    <span>Ready to start registration</span>
                </div>
            </div>
        `;
    }
    
    function startRegistrationProcess() {
        const steps = document.getElementById('registration-steps');
        steps.innerHTML = `
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-3">
                    <i class="fas fa-circle-notch fa-spin text-unilorin-blue"></i>
                    <span>Starting registration process...</span>
                </div>
            </div>
        `;
        
        fetch('/admin/api/users/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                steps.innerHTML = `
                    <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <span>${data.message}</span>
                        </div>
                    </div>
                `;
            } else {
                steps.innerHTML = `
                    <div class="flex items-center justify-between p-4 bg-red-50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-exclamation-circle text-red-500"></i>
                            <span>${data.message}</span>
                        </div>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error starting registration:', error);
            steps.innerHTML = `
                <div class="flex items-center justify-between p-4 bg-red-50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-exclamation-circle text-red-500"></i>
                        <span>Error starting registration process</span>
                    </div>
                </div>
            `;
        });
    }
</script>
{% endblock %}
